image: openjdk:17-jdk-alpine3.14

clone:
  depth: full

definitions:
  caches:
    sonar: ~/.sonar/cache
  steps:
    - step: &build-test-sonar
        name: Build, test and analyze on MGG Sonar
        caches:
          - gradle
          - sonar
        script:
          # add executable permission to gradlew
          - ./gradlew --refresh-dependencies
          - ./gradlew sonarqube
          - chmod +x gradlew
          - ./gradlew sonarqube

    - step: &build-deploy-azure-tomcat
        name: Build and deploy to app service (SIT)
        caches:
          - gradle
        script:
          # install curl to be used later
          - apk add curl
          # add executable permission to gradlew
          - chmod +x ./gradlew
          # Check and fix Gradle wrapper if needed
          - ls -la gradle/wrapper/ || mkdir -p gradle/wrapper/
          - if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          -   echo "Gradle wrapper JAR is missing - downloading it"
          -   apk add wget
          -   wget -O gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.4.0/gradle/wrapper/gradle-wrapper.jar
          - fi
          # Build the WAR file with detailed output
          - ./gradlew clean war
          
          # Deploy to Azure App Service
          - curl -vvvv POST -H "Authorization:Basic ${TOKEN}" "https://ocmsapisitintraapp.scm.azurewebsites.net/api/wardeploy?name=ocms" --data-binary "@./build/libs/ocms.war"
          
pipelines:
  # default:
    # - step: *build-test-sonar
  branches:
    mggsit:
      #- step: *build-test-sonar
      - step: *build-deploy-azure-tomcat
    master:
      #- step: *build-test-sonar
      #- step: *build-nexus-deploy-tomcat
    steven/my-codes:
      #- step: *build-test-sonar
